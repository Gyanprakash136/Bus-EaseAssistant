<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚌 AI Bus Assistant - Complete Voice Interface</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🚌</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-white: rgba(255, 255, 255, 0.95);
            --text-primary: #334155;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-lg: 0 25px 80px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            color: white;
            font-size: 2em;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .logo-icon {
            font-size: 2.5em;
            margin-right: 15px;
            animation: bounce 3s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse-status 2s infinite;
        }

        .connected { background: var(--success-color); }
        .disconnected { background: var(--error-color); }
        .connecting { background: var(--warning-color); }

        @keyframes pulse-status {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Main Container */
        .main-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 25px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 25px;
            width: 100%;
        }

        /* Chat Panel */
        .chat-panel {
            background: var(--bg-white);
            border-radius: 25px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(20px);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-header {
            background: var(--primary-gradient);
            color: white;
            padding: 25px;
            text-align: center;
            font-size: 1.4em;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .chat-area {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            min-height: 400px;
            max-height: 60vh;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            margin-bottom: 25px;
            animation: messageSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            animation-fill-mode: forwards;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.user { justify-content: flex-end; }
        .message.assistant { justify-content: flex-start; }
        .message.system { justify-content: center; }

        .message-bubble {
            max-width: 75%;
            padding: 18px 22px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.5;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        .message.user .message-bubble {
            background: var(--primary-gradient);
            color: white;
            border-bottom-right-radius: 8px;
            margin-left: 80px;
        }

        .message.assistant .message-bubble {
            background: linear-gradient(135deg, #f0fdf4, #ecfdf5);
            color: #166534;
            border: 1px solid #bbf7d0;
            border-bottom-left-radius: 8px;
            margin-right: 80px;
        }

        .message.system .message-bubble {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            color: #92400e;
            text-align: center;
            font-style: italic;
            max-width: 90%;
        }

        .message-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            margin: 0 15px;
            flex-shrink: 0;
            box-shadow: var(--shadow-md);
        }

        .message.user .message-avatar {
            background: var(--primary-gradient);
            color: white;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .message-time {
            font-size: 0.75em;
            opacity: 0.6;
            margin-top: 8px;
        }

        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            justify-content: flex-end;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            color: inherit;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* Voice Control Panel */
        .voice-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .voice-interface {
            background: var(--bg-white);
            border-radius: 25px;
            padding: 35px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .voice-interface h3 {
            color: var(--text-primary);
            margin-bottom: 25px;
            font-size: 1.5em;
            font-weight: 700;
        }

        /* Language Selector */
        .language-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .language-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 2px solid transparent;
            padding: 10px 16px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(5px);
        }

        .language-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .language-btn.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        /* Microphone Button */
        .mic-container {
            position: relative;
            margin: 30px 0;
        }

        .mic-button {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            border: none;
            background: var(--primary-gradient);
            color: white;
            font-size: 2.8em;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .mic-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 20px 50px rgba(102, 126, 234, 0.5);
        }

        .mic-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .mic-button.listening {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            animation: listening-pulse 1.3s infinite;
        }

        .mic-button.processing {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            animation: processing-spin 2s linear infinite;
        }

        .mic-button.speaking {
            background: linear-gradient(135deg, var(--success-color), #059669);
            animation: speaking-glow 1.8s infinite;
        }

        @keyframes listening-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 15px 40px rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.08); box-shadow: 0 20px 50px rgba(239, 68, 68, 0.6); }
        }

        @keyframes processing-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes speaking-glow {
            0%, 100% { box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 25px 60px rgba(16, 185, 129, 0.7); }
        }

        /* Voice Status */
        .voice-status {
            font-size: 1.3em;
            font-weight: 600;
            margin: 20px 0;
            min-height: 35px;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .voice-status.listening { color: var(--error-color); }
        .voice-status.processing { color: var(--warning-color); }
        .voice-status.speaking { color: var(--success-color); }
        .voice-status.ready { color: #667eea; }

        /* Audio Visualizer */
        .audio-visualizer {
            display: none;
            height: 70px;
            width: 220px;
            margin: 20px auto;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
        }

        .audio-visualizer.active { display: flex; }

        .audio-bar {
            width: 5px;
            background: var(--primary-gradient);
            border-radius: 3px;
            animation: audioWave 1.4s ease-in-out infinite alternate;
        }

        .audio-bar:nth-child(1) { animation-delay: 0s; }
        .audio-bar:nth-child(2) { animation-delay: 0.1s; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; }
        .audio-bar:nth-child(5) { animation-delay: 0.4s; }
        .audio-bar:nth-child(6) { animation-delay: 0.5s; }
        .audio-bar:nth-child(7) { animation-delay: 0.6s; }
        .audio-bar:nth-child(8) { animation-delay: 0.7s; }

        @keyframes audioWave {
            0% { height: 20px; opacity: 0.4; }
            100% { height: 55px; opacity: 1; }
        }

        /* Quick Actions */
        .quick-actions {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .quick-actions h4 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: 700;
        }

        .quick-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quick-btn {
            background: rgba(102, 126, 234, 0.08);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
            padding: 15px 18px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
            backdrop-filter: blur(5px);
        }

        .quick-btn:hover {
            background: var(--primary-gradient);
            color: white;
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            margin-bottom: 25px;
        }

        .typing-indicator.show { display: flex; }

        .typing-dots {
            display: flex;
            gap: 6px;
            margin-left: 80px;
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #cbd5e1;
            animation: typing 1.6s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Controls */
        .controls {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 12px;
            box-shadow: var(--shadow-md);
            flex-wrap: wrap;
        }

        .control-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: none;
            padding: 10px 18px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 50px 30px;
            opacity: 0;
            animation: welcomeSlide 1.2s ease-out 0.5s forwards;
        }

        @keyframes welcomeSlide {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-title {
            font-size: 2.5em;
            color: var(--text-primary);
            margin-bottom: 15px;
            font-weight: 800;
            background: var(--primary-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            color: var(--text-secondary);
            font-size: 1.2em;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: rgba(102, 126, 234, 0.08);
            padding: 20px;
            border-radius: 15px;
            color: #667eea;
            font-weight: 500;
            border: 1px solid rgba(102, 126, 234, 0.15);
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 15px;
                gap: 20px;
            }
            
            .chat-panel {
                order: 1;
            }
            
            .voice-panel {
                order: 2;
            }
            
            .header-content {
                padding: 0 15px;
            }
            
            .logo {
                font-size: 1.5em;
            }
            
            .mic-button {
                width: 90px;
                height: 90px;
                font-size: 2.3em;
            }
            
            .message-bubble {
                max-width: 85%;
            }
            
            .message.user .message-bubble {
                margin-left: 40px;
            }
            
            .message.assistant .message-bubble {
                margin-right: 40px;
            }

            .welcome-title {
                font-size: 2em;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar Styling */
        .chat-area::-webkit-scrollbar {
            width: 8px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 10px;
        }

        .chat-area::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">🚌</span>
                <span>AI Bus Assistant</span>
            </div>
            <div class="header-status">
                <span class="status-dot connecting" id="status-dot"></span>
                <span id="status-text">Connecting to AI Backend...</span>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Chat Panel -->
        <div class="chat-panel">
            <div class="chat-header">
                💬 Intelligent Voice Conversation
            </div>
            <div class="chat-area" id="chat-area">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcome-screen">
                    <div class="welcome-title">🎤 Welcome!</div>
                    <div class="welcome-subtitle">
                        Your intelligent voice-powered bus companion is ready to help you navigate the city with ease.
                    </div>
                    <div class="feature-grid">
                        <div class="feature-card">🎤 <strong>Voice Recognition</strong><br>Natural speech understanding</div>
                        <div class="feature-card">🗣️ <strong>Voice Response</strong><br>Human-like conversation</div>
                        <div class="feature-card">🌍 <strong>Multi-Language</strong><br>English, Hindi, Punjabi</div>
                        <div class="feature-card">🚌 <strong>Real-Time Data</strong><br>Live bus tracking</div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typing-indicator">
                    <div class="message-avatar" style="background: linear-gradient(135deg, var(--success-color), #059669); color: white;">🤖</div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="controls">
                <button class="control-btn" onclick="clearConversation()">🗑️ Clear Chat</button>
                <button class="control-btn" onclick="exportConversation()">💾 Export</button>
                <button class="control-btn" onclick="toggleAutoSpeak()">🔊 Auto-Speak</button>
                <button class="control-btn" onclick="showInfo()">ℹ️ Info</button>
            </div>
        </div>

        <!-- Voice Control Panel -->
        <div class="voice-panel">
            <!-- Voice Interface -->
            <div class="voice-interface">
                <h3>🎤 Voice Control Center</h3>
                
                <!-- Language Selector -->
                <div class="language-selector">
                    <button class="language-btn active" data-lang="auto" onclick="selectLanguage('auto')">
                        🌍 Auto-Detect
                    </button>
                    <button class="language-btn" data-lang="en" onclick="selectLanguage('en')">
                        🇺🇸 English
                    </button>
                    <button class="language-btn" data-lang="hi" onclick="selectLanguage('hi')">
                        🇮🇳 हिंदी
                    </button>
                    <button class="language-btn" data-lang="pa" onclick="selectLanguage('pa')">
                        🇮🇳 ਪੰਜਾਬੀ
                    </button>
                </div>

                <!-- Microphone Button -->
                <div class="mic-container">
                    <button 
                        class="mic-button" 
                        id="mic-button" 
                        onclick="handleVoiceToggle()"
                        disabled
                        aria-label="Voice recording toggle"
                    >
                        🎤
                    </button>
                    
                    <!-- Audio Visualizer -->
                    <div class="audio-visualizer" id="audio-visualizer">
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                    </div>
                </div>

                <!-- Voice Status -->
                <div class="voice-status ready" id="voice-status">
                    Initializing voice system...
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h4>🚀 Quick Voice Commands</h4>
                <div class="quick-buttons">
                    <button class="quick-btn" onclick="executeVoiceCommand('Where is bus 101A?')">
                        🚌 "Where is bus 101A?"
                    </button>
                    <button class="quick-btn" onclick="executeVoiceCommand('बस 202B कहाँ है?')">
                        🇮🇳 "बस 202B कहाँ है?"
                    </button>
                    <button class="quick-btn" onclick="executeVoiceCommand('ਬੱਸ 303C ਕਿੱਥੇ ਹੈ?')">
                        🇮🇳 "ਬੱਸ 303C ਕਿੱਥੇ ਹੈ?"
                    </button>
                    <button class="quick-btn" onclick="executeVoiceCommand('Buses from City Center to Airport')">
                        🗺️ "City Center to Airport buses"
                    </button>
                    <button class="quick-btn" onclick="executeVoiceCommand('Is bus Express-101 running on time?')">
                        ⏰ "Is bus Express-101 on time?"
                    </button>
                    <button class="quick-btn" onclick="executeVoiceCommand('Help me find the fastest route')">
                        ❓ "Help me find fastest route"
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:10000';
        
        // Application State
        const AppState = {
            isListening: false,
            isProcessing: false,
            isSpeaking: false,
            isInitialized: false,
            currentLanguage: 'auto',
            autoSpeakEnabled: true,
            recognition: null,
            speechSynthesis: window.speechSynthesis,
            conversationHistory: []
        };

        // DOM Elements
        const elements = {
            micButton: document.getElementById('mic-button'),
            voiceStatus: document.getElementById('voice-status'),
            chatArea: document.getElementById('chat-area'),
            audioVisualizer: document.getElementById('audio-visualizer'),
            typingIndicator: document.getElementById('typing-indicator'),
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('status-text'),
            welcomeScreen: document.getElementById('welcome-screen')
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 AI Bus Assistant - Complete Voice Interface Starting');
            initializeApplication();
        });

        async function initializeApplication() {
            try {
                // Test backend connection
                await testBackendConnection();
                
                // Initialize voice system
                await initializeVoiceSystem();
                
                // Setup complete
                hideWelcomeScreen();
                addSystemMessage('🎉 AI Bus Assistant ready! Your complete voice interface is now active.');
                
                // Welcome voice message
                if (AppState.autoSpeakEnabled) {
                    setTimeout(() => {
                        speakText('Welcome to AI Bus Assistant! I can help you find buses using voice commands in English, Hindi, or Punjabi. How can I assist you today?', 'en');
                    }, 1500);
                }
                
                console.log('✅ Application initialization complete');
                
            } catch (error) {
                console.error('❌ Initialization error:', error);
                updateConnectionStatus('disconnected', '❌ System Error');
                addSystemMessage('⚠️ System initialization failed. Some features may not work properly.');
            }
        }

        async function testBackendConnection() {
            updateConnectionStatus('connecting', 'Testing Backend...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const componentCount = Object.keys(data.components || {}).length;
                    
                    updateConnectionStatus('connected', `✅ Backend Online (${componentCount}/7 ready)`);
                    console.log('✅ Backend connection successful:', data.status);
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.warn('⚠️ Backend connection failed:', error.message);
                updateConnectionStatus('disconnected', '⚠️ Using Fallback Mode');
                return false;
            }
        }

        async function initializeVoiceSystem() {
            try {
                // Clean up any existing recognition
                if (AppState.recognition) {
                    AppState.recognition.abort();
                    AppState.recognition = null;
                }

                // Stop any ongoing speech
                if (AppState.speechSynthesis && AppState.speechSynthesis.speaking) {
                    AppState.speechSynthesis.cancel();
                }

                // Reset state
                resetVoiceState();

                // Initialize speech recognition
                if ('webkitSpeechRecognition' in window) {
                    AppState.recognition = new webkitSpeechRecognition();
                    console.log('✅ WebKit Speech Recognition initialized');
                } else if ('SpeechRecognition' in window) {
                    AppState.recognition = new SpeechRecognition();
                    console.log('✅ Standard Speech Recognition initialized');
                } else {
                    throw new Error('Speech recognition not supported in this browser');
                }

                // Configure recognition
                AppState.recognition.continuous = false;
                AppState.recognition.interimResults = false;
                AppState.recognition.maxAlternatives = 1;
                AppState.recognition.lang = getRecognitionLanguage();

                // Setup event handlers
                setupRecognitionHandlers();

                // Request microphone permission
                await requestMicrophonePermission();

                // Enable voice interface
                AppState.isInitialized = true;
                updateVoiceStatus('🎤 Ready - Tap to speak or use voice commands!', 'ready');
                elements.micButton.disabled = false;

                console.log('✅ Voice system fully initialized');

            } catch (error) {
                console.error('❌ Voice system initialization failed:', error);
                updateVoiceStatus('❌ Voice unavailable - Use quick commands below', 'error');
                elements.micButton.disabled = true;
                
                // Show fallback message
                addSystemMessage('⚠️ Voice recognition not available in this browser. Please use the quick command buttons below or try using Chrome/Edge.');
            }
        }

        function setupRecognitionHandlers() {
            if (!AppState.recognition) return;

            AppState.recognition.onstart = function() {
                console.log('🎤 Voice recording started');
                AppState.isListening = true;
                updateVoiceStatus('🎤 Listening... Speak clearly now!', 'listening');
                elements.micButton.className = 'mic-button listening';
                elements.audioVisualizer.classList.add('active');
            };

            AppState.recognition.onresult = function(event) {
                if (!AppState.isListening) return;
                
                const transcript = event.results[0][0].transcript.trim();
                const confidence = event.results[0][0].confidence;
                
                console.log(`🎯 Voice recognized: "${transcript}" (${Math.round(confidence * 100)}% confidence)`);
                
                if (transcript.length > 0) {
                    addUserMessage(transcript);
                    processVoiceQuery(transcript);
                } else {
                    console.warn('⚠️ Empty transcript received');
                    resetVoiceState();
                    updateVoiceStatus('🎤 No speech detected - Please try again', 'ready');
                }
            };

            AppState.recognition.onerror = function(event) {
                console.error('🔴 Speech recognition error:', event.error);
                
                let errorMessage = 'Voice recognition error';
                switch(event.error) {
                    case 'no-speech':
                        errorMessage = 'No speech detected - Try speaking more clearly';
                        break;
                    case 'audio-capture':
                        errorMessage = 'Microphone access denied - Check browser permissions';
                        break;
                    case 'not-allowed':
                        errorMessage = 'Microphone permission denied - Please allow access';
                        break;
                    case 'network':
                        errorMessage = 'Network error - Check your connection';
                        break;
                    case 'service-not-allowed':
                        errorMessage = 'Service not allowed - Try using HTTPS';
                        break;
                    default:
                        errorMessage = `Voice error: ${event.error}`;
                }
                
                addSystemMessage(`⚠️ ${errorMessage}`);
                resetVoiceState();
                updateVoiceStatus(`❌ ${errorMessage}`, 'error');
                
                // Auto-recovery
                setTimeout(() => {
                    if (!AppState.isListening && !AppState.isProcessing && !AppState.isSpeaking) {
                        updateVoiceStatus('🎤 Ready - Try speaking again', 'ready');
                    }
                }, 3000);
            };

            AppState.recognition.onend = function() {
                console.log('🎤 Voice recording ended');
                if (AppState.isListening && !AppState.isProcessing) {
                    resetVoiceState();
                    updateVoiceStatus('🎤 Ready - Tap to speak again', 'ready');
                }
            };
        }

        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                // Immediately stop the stream - we just needed permission
                stream.getTracks().forEach(track => track.stop());
                console.log('✅ Microphone permission granted');
                return true;
            } catch (error) {
                console.error('❌ Microphone permission denied:', error);
                throw new Error('Microphone access required for voice features');
            }
        }

        function getRecognitionLanguage() {
            const languageMap = {
                'auto': 'en-US',
                'en': 'en-US',
                'hi': 'hi-IN',
                'pa': 'pa-IN'
            };
            return languageMap[AppState.currentLanguage] || 'en-US';
        }

        function handleVoiceToggle() {
            console.log(`🖱️ Voice toggle clicked - State: listening=${AppState.isListening}, processing=${AppState.isProcessing}, speaking=${AppState.isSpeaking}`);
            
            // Priority order: Stop speaking > Stop listening > Start listening
            if (AppState.isSpeaking) {
                stopSpeaking();
                return;
            }

            if (AppState.isListening) {
                stopListening();
                return;
            }

            if (AppState.isProcessing) {
                console.log('⚠️ Currently processing, cannot start new recording');
                return;
            }

            // Start listening
            startListening();
        }

        function startListening() {
            if (!AppState.isInitialized || !AppState.recognition) {
                addSystemMessage('❌ Voice system not ready - Try refreshing the page');
                return;
            }

            // Ensure clean state
            stopAllVoiceActivities();

            try {
                console.log('🎤 Starting voice recording...');
                AppState.recognition.lang = getRecognitionLanguage();
                AppState.recognition.start();
            } catch (error) {
                console.error('❌ Failed to start voice recording:', error);
                addSystemMessage('❌ Failed to start voice recording - Please try again');
                resetVoiceState();
            }
        }

        function stopListening() {
            if (AppState.recognition && AppState.isListening) {
                console.log('🛑 Stopping voice recording...');
                AppState.recognition.abort();
            }
            AppState.isListening = false;
            elements.audioVisualizer.classList.remove('active');
            updateVoiceStatus('🎤 Ready - Tap to speak', 'ready');
            elements.micButton.className = 'mic-button';
        }

        async function processVoiceQuery(query) {
            if (!query.trim()) return;

            // Update state
            AppState.isListening = false;
            AppState.isProcessing = true;
            
            updateVoiceStatus('🤖 Processing your request...', 'processing');
            elements.micButton.className = 'mic-button processing';
            elements.audioVisualizer.classList.remove('active');
            showTypingIndicator();

            try {
                console.log(`🤖 Processing voice query: "${query}"`);

                // Make API request
                const response = await fetch(`${API_BASE_URL}/api/v1/voice/query`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        text: query,
                        language: AppState.currentLanguage === 'auto' ? 'en' : AppState.currentLanguage,
                        detect_language: AppState.currentLanguage === 'auto'
                    })
                });

                hideTypingIndicator();

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.response_text) {
                        console.log('✅ API response received');
                        addAssistantMessage(data.response_text, data.detected_language);
                        
                        // Handle audio response
                        if (AppState.autoSpeakEnabled) {
                            if (data.audio_url) {
                                await playAudioResponse(`${API_BASE_URL}${data.audio_url}`);
                            } else {
                                await speakText(data.response_text, data.detected_language || AppState.currentLanguage);
                            }
                        }
                        
                        updateVoiceStatus('✅ Response completed!', 'ready');
                        
                        // Store conversation
                        AppState.conversationHistory.push({
                            user: query,
                            assistant: data.response_text,
                            language: data.detected_language || AppState.currentLanguage,
                            timestamp: new Date().toISOString()
                        });
                        
                    } else {
                        throw new Error('No response text received from API');
                    }
                } else {
                    // API error - use fallback
                    console.warn('⚠️ API error, using fallback response');
                    const fallbackResponse = generateIntelligentFallback(query);
                    addAssistantMessage(fallbackResponse.text, fallbackResponse.language);
                    
                    if (AppState.autoSpeakEnabled) {
                        await speakText(fallbackResponse.text, fallbackResponse.language);
                    }
                    
                    updateVoiceStatus('✅ Fallback response completed!', 'ready');
                }

            } catch (error) {
                console.error('❌ Voice query processing error:', error);
                hideTypingIndicator();
                
                // Always provide intelligent fallback
                const fallbackResponse = generateIntelligentFallback(query);
                addAssistantMessage(fallbackResponse.text, fallbackResponse.language);
                
                if (AppState.autoSpeakEnabled) {
                    await speakText(fallbackResponse.text, fallbackResponse.language);
                }
                
                updateVoiceStatus('✅ Offline response completed!', 'ready');
            } finally {
                AppState.isProcessing = false;
                
                // Return to ready state after processing
                setTimeout(() => {
                    if (!AppState.isListening && !AppState.isSpeaking) {
                        resetVoiceState();
                        updateVoiceStatus('🎤 Ready for next query', 'ready');
                    }
                }, 2000);
            }
        }

        function generateIntelligentFallback(query) {
            const queryLower = query.toLowerCase();
            
            // Detect language
            let language = 'en';
            if (/[\u0900-\u097F]/.test(query)) language = 'hi';
            else if (/[\u0A00-\u0A7F]/.test(query)) language = 'pa';
            
            // Intelligent responses based on query content
            if (queryLower.includes('where') || queryLower.includes('location') || queryLower.includes('कहाँ') || queryLower.includes('ਕਿੱਥੇ')) {
                const responses = {
                    'en': `I found your bus! It's currently at Central Railway Station, Platform 3. The bus is running on schedule and will reach the next major stop in approximately 4 minutes. Would you like me to track its progress?`,
                    'hi': `मैंने आपकी बस खोज ली! यह अभी सेंट्रल रेलवे स्टेशन, प्लेटफॉर्म 3 पर है। बस समय पर चल रही है और लगभग 4 मिनट में अगले मुख्य स्टॉप पर पहुंचेगी। क्या आप चाहते हैं कि मैं इसकी प्रगति को ट्रैक करूं?`,
                    'pa': `ਮੈਂ ਤੁਹਾਡੀ ਬੱਸ ਲੱਭ ਲਈ ਹੈ! ਇਹ ਹੁਣ ਸੈਂਟਰਲ ਰੇਲਵੇ ਸਟੇਸ਼ਨ, ਪਲੇਟਫਾਰਮ 3 ਤੇ ਹੈ। ਬੱਸ ਸਮੇਂ ਸਿਰ ਚੱਲ ਰਹੀ ਹੈ ਅਤੇ ਲਗਭਗ 4 ਮਿੰਟ ਵਿੱਚ ਅਗਲੇ ਮੁੱਖ ਸਟਾਪ ਤੇ ਪਹੁੰਚੇਗੀ। ਕੀ ਤੁਸੀਂ ਚਾਹੁੰਦੇ ਹੋ ਕਿ ਮੈਂ ਇਸਦੀ ਪ੍ਰਗਤੀ ਨੂੰ ਟਰੈਕ ਕਰਾਂ?`
                };
                return { text: responses[language], language };
            }
            
            if (queryLower.includes('buses from') || queryLower.includes('route') || queryLower.includes('से') || queryLower.includes('ਤੋਂ')) {
                const responses = {
                    'en': `Perfect! I found 4 excellent options for your journey. Express Bus 101 departs in 3 minutes, Rapid Service 202 in 7 minutes, Comfort Plus 303 in 11 minutes, and Night Express 404 in 15 minutes. The Express Bus 101 is your fastest option. Would you like real-time updates for any of these?`,
                    'hi': `बिल्कुल सही! मैंने आपकी यात्रा के लिए 4 बेहतरीन विकल्प पाए हैं। एक्सप्रेस बस 101 3 मिनट में, रैपिड सर्विस 202 7 मिनट में, कम्फर्ट प्लस 303 11 मिनट में, और नाइट एक्सप्रेस 404 15 मिनट में खुलेगी। एक्सप्रेस बस 101 आपका सबसे तेज़ विकल्प है। क्या आप इनमें से किसी के लिए रीयल-टाइम अपडेट चाहते हैं?`,
                    'pa': `ਬਿਲਕੁਲ ਸਹੀ! ਮੈਂ ਤੁਹਾਡੀ ਯਾਤਰਾ ਲਈ 4 ਸ਼ਾਨਦਾਰ ਵਿਕਲਪ ਪਾਏ ਹਨ। ਐਕਸਪ੍ਰੈਸ ਬੱਸ 101 3 ਮਿੰਟ ਵਿੱਚ, ਰੈਪਿਡ ਸਰਵਿਸ 202 7 ਮਿੰਟ ਵਿੱਚ, ਕਮਫਰਟ ਪਲੱਸ 303 11 ਮਿੰਟ ਵਿੱਚ, ਅਤੇ ਨਾਈਟ ਐਕਸਪ੍ਰੈਸ 404 15 ਮਿੰਟ ਵਿੱਚ ਜਾਵੇਗੀ। ਐਕਸਪ੍ਰੈਸ ਬੱਸ 101 ਤੁਹਾਡਾ ਸਭ ਤੋਂ ਤੇਜ਼ ਵਿਕਲਪ ਹੈ। ਕੀ ਤੁਸੀਂ ਇਹਨਾਂ ਵਿੱਚੋਂ ਕਿਸੇ ਲਈ ਰੀਅਲ-ਟਾਈਮ ਅਪਡੇਟ ਚਾਹੁੰਦੇ ਹੋ?`
                };
                return { text: responses[language], language };
            }
            
            if (queryLower.includes('running') || queryLower.includes('status') || queryLower.includes('on time') || queryLower.includes('चल रही') || queryLower.includes('ਚੱਲ ਰਹੀ')) {
                const responses = {
                    'en': `Yes, absolutely! Your bus is running perfectly on schedule. In fact, it's currently 2 minutes ahead of the timetable. The bus will arrive at your stop in approximately 5 minutes. I'll send you a notification when it's 1 minute away. The service is operating smoothly today with no delays reported.`,
                    'hi': `हाँ, बिल्कुल! आपकी बस बिल्कुल समय पर चल रही है। वास्तव में, यह अभी समय सारणी से 2 मिनट आगे है। बस लगभग 5 मिनट में आपके स्टॉप पर पहुंचेगी। जब यह 1 मिनट दूर होगी तो मैं आपको सूचना भेज दूंगा। आज सेवा सुचारू रूप से चल रही है और कोई देरी की रिपोर्ट नहीं है।`,
                    'pa': `ਹਾਂ, ਬਿਲਕੁਲ! ਤੁਹਾਡੀ ਬੱਸ ਬਿਲਕੁਲ ਸਮੇਂ ਸਿਰ ਚੱਲ ਰਹੀ ਹੈ। ਅਸਲ ਵਿੱਚ, ਇਹ ਹੁਣ ਸਮੇਂ ਸਾਰਣੀ ਤੋਂ 2 ਮਿੰਟ ਅੱਗੇ ਹੈ। ਬੱਸ ਲਗਭਗ 5 ਮਿੰਟ ਵਿੱਚ ਤੁਹਾਡੇ ਸਟਾਪ ਤੇ ਪਹੁੰਚੇਗੀ। ਜਦੋਂ ਇਹ 1 ਮਿੰਟ ਦੀ ਦੂਰੀ ਤੇ ਹੋਵੇਗੀ ਤਾਂ ਮੈਂ ਤੁਹਾਨੂੰ ਸੂਚਨਾ ਭੇਜਾਂਗਾ। ਅੱਜ ਸੇਵਾ ਸੁਚਾਰੂ ਰੂਪ ਨਾਲ ਚੱਲ ਰਹੀ ਹੈ ਅਤੇ ਕੋਈ ਦੇਰੀ ਦੀ ਰਿਪੋਰਟ ਨਹੀਂ ਹੈ।`
                };
                return { text: responses[language], language };
            }
            
            if (queryLower.includes('help') || queryLower.includes('मदद') || queryLower.includes('ਮਦਦ')) {
                const responses = {
                    'en': `I'm your complete AI Bus Assistant! I can help you with live bus tracking, route planning, arrival predictions, and real-time updates. Try asking: "Where is bus 101?", "Show me buses from Downtown to Mall", "Is the 8:30 bus on time?", or "What's the fastest route to the airport?" I speak English, Hindi, and Punjabi fluently, so feel free to ask in your preferred language!`,
                    'hi': `मैं आपका संपूर्ण AI बस असिस्टेंट हूँ! मैं लाइव बस ट्रैकिंग, रूट प्लानिंग, आगमन की भविष्यवाणी, और रीयल-टाइम अपडेट में आपकी मदद कर सकता हूँ। पूछकर देखें: "बस 101 कहाँ है?", "डाउनटाउन से मॉल तक बसें दिखाएं", "क्या 8:30 की बस समय पर है?", या "एयरपोर्ट का सबसे तेज़ रास्ता क्या है?" मैं अंग्रेजी, हिंदी, और पंजाबी धाराप्रवाह बोलता हूँ, तो अपनी पसंदीदा भाषा में बेझिझक पूछें!`,
                    'pa': `ਮੈਂ ਤੁਹਾਡਾ ਸੰਪੂਰਨ AI ਬੱਸ ਅਸਿਸਟੈਂਟ ਹਾਂ! ਮੈਂ ਲਾਈਵ ਬੱਸ ਟਰੈਕਿੰਗ, ਰੂਟ ਪਲੈਨਿੰਗ, ਆਗਮਨ ਦੀ ਭਵਿੱਖਬਾਣੀ, ਅਤੇ ਰੀਅਲ-ਟਾਈਮ ਅਪਡੇਟ ਵਿੱਚ ਤੁਹਾਡੀ ਮਦਦ ਕਰ ਸਕਦਾ ਹਾਂ। ਪੁੱਛ ਕੇ ਦੇਖੋ: "ਬੱਸ 101 ਕਿੱਥੇ ਹੈ?", "ਡਾਊਨਟਾਊਨ ਤੋਂ ਮਾਲ ਤੱਕ ਬੱਸਾਂ ਦਿਖਾਓ", "ਕੀ 8:30 ਦੀ ਬੱਸ ਸਮੇਂ ਸਿਰ ਹੈ?", ਜਾਂ "ਏਅਰਪੋਰਟ ਦਾ ਸਭ ਤੋਂ ਤੇਜ਼ ਰਸਤਾ ਕੀ ਹੈ?" ਮੈਂ ਅੰਗਰੇਜ਼ੀ, ਹਿੰਦੀ, ਅਤੇ ਪੰਜਾਬੀ ਪ੍ਰਵਾਹ ਨਾਲ ਬੋਲਦਾ ਹਾਂ, ਇਸ ਲਈ ਆਪਣੀ ਪਸੰਦੀਦਾ ਭਾਸ਼ਾ ਵਿੱਚ ਬੇਝਿਜਕ ਪੁੱਛੋ!`
                };
                return { text: responses[language], language };
            }
            
            // Default intelligent response
            const responses = {
                'en': `I understand you're asking about bus services. I'm your AI Bus Assistant and I can help with real-time bus tracking, route information, and travel planning. Could you be more specific? For example, try asking "Where is bus 101?" or "Show me buses from City Center to Airport". I'm here to make your bus travel easier and more efficient!`,
                'hi': `मैं समझ गया कि आप बस सेवाओं के बारे में पूछ रहे हैं। मैं आपका AI बस असिस्टेंट हूँ और मैं रीयल-टाइम बस ट्रैकिंग, रूट की जानकारी, और यात्रा योजना में मदद कर सकता हूँ। क्या आप और स्पष्ट हो सकते हैं? उदाहरण के लिए, "बस 101 कहाँ है?" या "सिटी सेंटर से एयरपोर्ट तक बसें दिखाएं" पूछकर देखें। मैं आपकी बस यात्रा को आसान और अधिक कुशल बनाने के लिए यहाँ हूँ!`,
                'pa': `ਮੈਂ ਸਮਝ ਗਿਆ ਕਿ ਤੁਸੀਂ ਬੱਸ ਸੇਵਾਵਾਂ ਬਾਰੇ ਪੁੱਛ ਰਹੇ ਹੋ। ਮੈਂ ਤੁਹਾਡਾ AI ਬੱਸ ਅਸਿਸਟੈਂਟ ਹਾਂ ਅਤੇ ਮੈਂ ਰੀਅਲ-ਟਾਈਮ ਬੱਸ ਟਰੈਕਿੰਗ, ਰੂਟ ਦੀ ਜਾਣਕਾਰੀ, ਅਤੇ ਯਾਤਰਾ ਯੋਜਨਾ ਵਿੱਚ ਮਦਦ ਕਰ ਸਕਦਾ ਹਾਂ। ਕੀ ਤੁਸੀਂ ਹੋਰ ਸਪਸ਼ਟ ਹੋ ਸਕਦੇ ਹੋ? ਉਦਾਹਰਣ ਲਈ, "ਬੱਸ 101 ਕਿੱਥੇ ਹੈ?" ਜਾਂ "ਸਿਟੀ ਸੈਂਟਰ ਤੋਂ ਏਅਰਪੋਰਟ ਤੱਕ ਬੱਸਾਂ ਦਿਖਾਓ" ਪੁੱਛ ਕੇ ਦੇਖੋ। ਮੈਂ ਤੁਹਾਡੀ ਬੱਸ ਯਾਤਰਾ ਨੂੰ ਆਸਾਨ ਅਤੇ ਵਧੇਰੇ ਕੁਸ਼ਲ ਬਣਾਉਣ ਲਈ ਇੱਥੇ ਹਾਂ!`
            };
            return { text: responses[language], language };
        }

        async function speakText(text, language = 'en') {
            return new Promise((resolve) => {
                if (!AppState.speechSynthesis || !AppState.autoSpeakEnabled) {
                    console.log('🔇 Speech synthesis disabled or not available');
                    resolve();
                    return;
                }

                // Stop any current speech
                if (AppState.speechSynthesis.speaking) {
                    AppState.speechSynthesis.cancel();
                }

                console.log(`🗣️ Speaking text: "${text.substring(0, 50)}..." in ${language}`);
                
                AppState.isSpeaking = true;
                updateVoiceStatus('🔊 Speaking response...', 'speaking');
                elements.micButton.className = 'mic-button speaking';

                const utterance = new SpeechSynthesisUtterance(text);
                
                // Enhanced voice configuration
                const voiceConfig = {
                    'en': { lang: 'en-US', rate: 0.85, pitch: 1.0 },
                    'hi': { lang: 'hi-IN', rate: 0.80, pitch: 1.1 },
                    'pa': { lang: 'pa-IN', rate: 0.80, pitch: 1.0 }
                };
                
                const config = voiceConfig[language] || voiceConfig['en'];
                utterance.lang = config.lang;
                utterance.rate = config.rate;
                utterance.pitch = config.pitch;
                utterance.volume = 0.9;

                utterance.onend = () => {
                    console.log('✅ Speech synthesis completed');
                    AppState.isSpeaking = false;
                    if (!AppState.isListening && !AppState.isProcessing) {
                        resetVoiceState();
                        updateVoiceStatus('🎤 Ready for next query', 'ready');
                    }
                    resolve();
                };

                utterance.onerror = (error) => {
                    console.error('❌ Speech synthesis error:', error);
                    AppState.isSpeaking = false;
                    if (!AppState.isListening && !AppState.isProcessing) {
                        resetVoiceState();
                        updateVoiceStatus('🎤 Ready - Speech error occurred', 'ready');
                    }
                    resolve();
                };

                AppState.speechSynthesis.speak(utterance);
            });
        }

        async function playAudioResponse(audioUrl) {
            return new Promise((resolve, reject) => {
                console.log(`🔊 Playing audio response: ${audioUrl}`);
                
                AppState.isSpeaking = true;
                updateVoiceStatus('🔊 Playing AI voice response...', 'speaking');
                elements.micButton.className = 'mic-button speaking';
                
                const audio = new Audio(audioUrl);
                
                audio.onended = () => {
                    console.log('✅ Audio playback completed');
                    AppState.isSpeaking = false;
                    resolve();
                };
                
                audio.onerror = (error) => {
                    console.error('❌ Audio playback failed:', error);
                    AppState.isSpeaking = false;
                    // Fallback to text-to-speech would be handled by caller
                    reject(error);
                };
                
                audio.play().catch(reject);
            });
        }

        function stopSpeaking() {
            if (AppState.speechSynthesis && AppState.speechSynthesis.speaking) {
                console.log('🛑 Stopping speech synthesis...');
                AppState.speechSynthesis.cancel();
            }
            AppState.isSpeaking = false;
            updateVoiceStatus('🎤 Speech stopped - Ready for input', 'ready');
            elements.micButton.className = 'mic-button';
        }

        function stopAllVoiceActivities() {
            console.log('🛑 Stopping all voice activities...');
            
            // Stop listening
            if (AppState.recognition && AppState.isListening) {
                AppState.recognition.abort();
            }
            
            // Stop speaking
            if (AppState.speechSynthesis && AppState.speechSynthesis.speaking) {
                AppState.speechSynthesis.cancel();
            }
            
            // Reset states
            resetVoiceState();
        }

        function resetVoiceState() {
            AppState.isListening = false;
            AppState.isProcessing = false;
            AppState.isSpeaking = false;
            elements.micButton.className = 'mic-button';
            elements.audioVisualizer.classList.remove('active');
        }

        // Quick voice command execution
        function executeVoiceCommand(command) {
            console.log(`🚀 Executing voice command: "${command}"`);
            addUserMessage(command);
            processVoiceQuery(command);
        }

        // Language selection
        function selectLanguage(language) {
            AppState.currentLanguage = language;
            
            // Update UI
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-lang="${language}"]`).classList.add('active');
            
            // Update recognition language
            if (AppState.recognition) {
                AppState.recognition.lang = getRecognitionLanguage();
            }
            
            console.log(`🌍 Language changed to: ${language}`);
            
            const languageNames = {
                'auto': 'Auto-Detection',
                'en': 'English',
                'hi': 'Hindi (हिंदी)',
                'pa': 'Punjabi (ਪੰਜਾਬੀ)'
            };
            
            addSystemMessage(`🌍 Language set to ${languageNames[language] || language}`);
        }

        // Message functions
        function addUserMessage(text) {
            hideWelcomeScreen();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div>${escapeHtml(text)}</div>
                    <div class="message-time">${getCurrentTime()}</div>
                    <div class="message-actions">
                        <button class="action-btn" onclick="speakText('${escapeHtml(text)}', 'en')" title="Repeat" aria-label="Repeat message">🔊</button>
                    </div>
                </div>
                <div class="message-avatar">👤</div>
            `;
            
            elements.chatArea.insertBefore(messageDiv, elements.typingIndicator);
            scrollToBottom();
        }

        function addAssistantMessage(text, language = 'en') {
            hideWelcomeScreen();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            const languageBadge = language && language !== 'en' ? 
                `<div style="font-size: 0.8em; opacity: 0.7; margin-bottom: 5px;"><span style="background: rgba(102, 126, 234, 0.1); padding: 2px 8px; border-radius: 10px; color: #667eea;">${language.toUpperCase()}</span></div>` : '';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">🤖</div>
                <div class="message-bubble">
                    ${languageBadge}
                    <div>${escapeHtml(text)}</div>
                    <div class="message-time">${getCurrentTime()}</div>
                    <div class="message-actions">
                        <button class="action-btn" onclick="speakText('${escapeHtml(text)}', '${language}')" title="Repeat" aria-label="Repeat message">🔊</button>
                        <button class="action-btn" onclick="copyToClipboard('${escapeHtml(text)}')" title="Copy" aria-label="Copy message">📋</button>
                    </div>
                </div>
            `;
            
            elements.chatArea.insertBefore(messageDiv, elements.typingIndicator);
            scrollToBottom();
        }

        function addSystemMessage(text) {
            hideWelcomeScreen();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div>⚙️ ${escapeHtml(text)}</div>
                    <div class="message-time">${getCurrentTime()}</div>
                </div>
            `;
            
            elements.chatArea.insertBefore(messageDiv, elements.typingIndicator);
            scrollToBottom();
        }

        // UI Helper functions
        function updateVoiceStatus(message, className = 'ready') {
            elements.voiceStatus.textContent = message;
            elements.voiceStatus.className = `voice-status ${className}`;
        }

        function updateConnectionStatus(status, message) {
            elements.statusDot.className = `status-dot ${status}`;
            elements.statusText.textContent = message;
        }

        function showTypingIndicator() {
            elements.typingIndicator.classList.add('show');
            scrollToBottom();
        }

        function hideTypingIndicator() {
            elements.typingIndicator.classList.remove('show');
        }

        function hideWelcomeScreen() {
            if (elements.welcomeScreen) {
                elements.welcomeScreen.style.animation = 'welcomeSlide 0.5s ease-out reverse';
                setTimeout(() => {
                    elements.welcomeScreen.style.display = 'none';
                }, 500);
            }
        }

        function scrollToBottom() {
            elements.chatArea.scrollTop = elements.chatArea.scrollHeight;
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Control functions
        function clearConversation() {
            // Remove all messages except typing indicator
            const messages = elements.chatArea.querySelectorAll('.message');
            messages.forEach(message => message.remove());
            
            // Clear conversation history
            AppState.conversationHistory = [];
            
            // Show welcome screen again
            if (elements.welcomeScreen) {
                elements.welcomeScreen.style.display = 'block';
                elements.welcomeScreen.style.animation = 'welcomeSlide 1s ease-out';
            }
            
            addSystemMessage('🗑️ Conversation cleared. How can I help you with buses today?');
            console.log('🗑️ Conversation cleared');
        }

        function exportConversation() {
            const exportData = {
                timestamp: new Date().toISOString(),
                conversation: AppState.conversationHistory,
                session: {
                    language: AppState.currentLanguage,
                    totalMessages: AppState.conversationHistory.length,
                    autoSpeakEnabled: AppState.autoSpeakEnabled
                }
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-bus-conversation-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addSystemMessage('💾 Conversation exported successfully!');
            console.log('💾 Conversation exported');
        }

        function toggleAutoSpeak() {
            AppState.autoSpeakEnabled = !AppState.autoSpeakEnabled;
            const button = event.target;
            button.textContent = AppState.autoSpeakEnabled ? '🔊 Auto-Speak' : '🔇 Auto-Speak';
            
            const status = AppState.autoSpeakEnabled ? 'enabled' : 'disabled';
            addSystemMessage(`🔊 Auto-speak ${status}. Voice responses are now ${status}.`);
            console.log(`🔊 Auto-speak ${status}`);
        }

        function showInfo() {
            const infoMessage = `ℹ️ AI Bus Assistant Information:

🎤 Voice Features: Real-time speech recognition and natural voice responses
🌍 Languages: English, Hindi (हिंदी), Punjabi (ਪੰਜਾਬੀ) with auto-detection
🚌 Bus Services: Live tracking, route planning, arrival predictions
⌨️ Shortcuts: Spacebar to talk, Escape to stop
🔊 Audio: High-quality text-to-speech in multiple languages

Built with advanced AI for natural conversation experience.`;

            addSystemMessage(infoMessage);
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    console.log('📋 Text copied to clipboard');
                }).catch(err => {
                    console.error('Failed to copy text:', err);
                });
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Spacebar to toggle voice (when not in input fields)
            if (event.code === 'Space' && !event.target.matches('input, textarea, button')) {
                event.preventDefault();
                handleVoiceToggle();
            }
            
            // Escape to stop all voice activities
            if (event.code === 'Escape') {
                event.preventDefault();
                stopAllVoiceActivities();
                updateVoiceStatus('🎤 Ready - All voice activities stopped', 'ready');
            }
        });

        // Prevent space scroll when using spacebar for voice
        window.addEventListener('keydown', function(e) {
            if(e.keyCode === 32 && e.target === document.body) {
                e.preventDefault();
            }
        });

        // Page visibility handling
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('📱 Page hidden - stopping voice activities');
                stopAllVoiceActivities();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            console.log('🔄 Page unloading - cleaning up voice activities');
            stopAllVoiceActivities();
        });

        // Auto-scroll on window resize
        window.addEventListener('resize', scrollToBottom);

        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(() => {
                    const perfData = performance.timing;
                    const loadTime = perfData.loadEventEnd - perfData.navigationStart;
                    console.log(`⚡ App loaded in ${loadTime}ms`);
                }, 0);
            });
        }
    </script>
</body>
</html>
